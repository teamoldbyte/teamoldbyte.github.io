$(function(){function r(e,t){for(refund of t){var n=$("#hiddenDivs .refund-detail-block").clone();n.find(".name").text(refund.orderLineItem.item?.name??"이름 없음"),n.find(".quantity").text(refund.orderLineItem.quantity??"수량정보 없음"),n.find(".amount").text(refund.refundAmount),"R"==refund.status&&(e.closest(".order-detail-block").find(".js-open-refund-cancel")[0].dataset.refundId=refund.rid,n.find(".amount").text("-")),n.find(".status").text(refund.status),n.find(".reason").text(refund.reason),n.find(".request-date").text(new Date(refund.updateDate).format("yyyy-MM-dd HH:mm")),refund.refundDate&&n.find(".refund-date").text(new Date(refund.refundDate).format("yyyy-MM-dd HH:mm")),e.append(n),n[0].dataset.refundId=refund.rid}}$(document).on("show.bs.collapse",".js-list-refund:not(.listed)",function(){let t=this,n=$(this).closest(".order-detail-block");var e=this.dataset.orderId;$.getJSON("/order/refund/list/"+e,function(e){$(t).addClass("listed"),r(n.find(".refund-list"),e),$(t).removeClass("js-list-refund")})}).on("click",".js-open-refund-request",function(){let t=$(this).closest(".order-detail-block"),{orderId:n,orderLineItemId:d}=this.dataset;confirmModal('<p>환불을 요청하시겠습니까?</p><input type="textarea" id="inputRefundReason" class="form-control" placeholder="환불사유" style="resize:none;">',function(){var e=$("#inputRefundReason").val();e?$.ajax({type:"POST",url:"/order/refund/request",contentType:"application/json",data:JSON.stringify({orderId:parseInt(n),reason:e,orderLineItemIdList:[parseInt(d)]}),success:function(e){alertModal('<p>환불 요청이 접수되었습니다.</p><p>관리자가 요청을 확인한 뒤 환불 요건을 검토합니다.<br>이용 내역이 있을 경우 해당 금액을 차감하여 환불되며,<br>처리는 영업일 기준 3일 이내에 완료됩니다.<br>환불 완료 시 문자 또는 이메일로 안내드립니다.</p><p>자세한 내용은 "<a href="/policy/refund">환불 정책</a>"을 참조하세요.</p>'),e&&(t.find(".refund-area").empty().append($("#hiddenDivs .refund-process-group").clone().children()),r(t.find(".refund-list"),e),t.find(".order-status").text("환불 요청"))},error:function(){alertModal("환불 요청이 실패했습니다.")}}):alertModal("환불사유를 입력해 주세요.")})}).on("click",".js-open-refund-cancel",function(){let n=$(this).closest(".order-detail-block"),d=this.dataset.refundId,r=n.find(".refund-detail-block").filter((e,t)=>t.dataset.refundId==d),a=n[0].dataset.orderId,o=n.find(".order-line-item-block")[0].dataset.orderLineItemId;confirmModal("환불을 취소하시겠습니까?",function(){$.ajax({type:"POST",url:"/order/refund/cancel",contentType:"application/json",data:d,success:function(){n.find(".order-status").text("결제 완료"),r.find(".status").text("환불 취소");var e=n.find(".refund-area"),t=$("#hiddenDivs .refund-request-group").clone();t.find("button")[0].dataset.orderId=a,t.find("button")[0].dataset.orderLineItemId=o,e.empty().append(t.children())},error:function(){alertModal("환불 취소에 실패했습니다.")}})})})});